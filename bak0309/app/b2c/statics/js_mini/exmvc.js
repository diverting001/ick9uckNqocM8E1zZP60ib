(function(){Element.implement({delegate:function(h,i,l,k,j){this.addEvent(i,function(o){var n=$(o.target),m=this.getElements(h);j!=null&&Array.from(j);if(m.contains(n)){l.apply(k,j==null?[n,o]:j.concat([n,o]))}})}});var c=this.ExMvc={},b={_create:function(){return(typeof Object.create!=="function"||Browser.ie)?(function(i){function h(){}h.prototype=i;return new h()})(this):Object.create(this)},extend:function(h){return Object.append(this._create(),h||{})},initance:function(){var h=this._create();h.init&&h.init.apply(h,arguments);return h}},d={map:{add:"post",update:"put",remove:"delete",get:"get"},getUrl:function(h,m,l){var k=["-",".html"],i,j;if(!h){return}j=h[1];h[1]=h[1].replace(/\{(.*)\}/,l);i=h.join(k[0]);if("add get".indexOf(l)>-1){i=h[0]+k[0]+h[1]}else{i=i.replace(/\{[^\}]+\}/g,function(n){var o=n.substring(1,n.length-1);return !!m[o]?m[o]:n})}h[1]=j;return i+k[1]},sync:function(l,j,h){var i=l.toJSON(),k;h.url=h.url||d.getUrl(h.route,i,j);if(!h.data&&l&&("add update".indexOf(j)>-1)){h.data=Object.toQueryString(i)}h.method=h.method||d.map[j];h.secure=false;if(k&&k.running){k.cancel()}k=new Request.JSON(h).send()}};b=b.extend(new Events).extend(new Options);var a=c.Records=b.extend({idAttribute:"id",init:function(i,h){this.attributes={};this.cid=Slick.uidOf(this.idAttribute);h=this.setOptions(h).options;if(h&&h.idAttribute){this.idAttribute=h.idAttribute}i&&this.set(i);if(h.model){this.model=h.model}this.fireEvent("init")},set:function(i){if(!i){return this}if(i.attributes){i=i.attributes}this.fireEvent("check",i);if(this.checked){return false}if(this.idAttribute in i){this.id=i[this.idAttribute]}for(var h in i){var j=i[h];this.attributes[h]=j;this.fireEvent("change:"+h,j)}this.fireEvent("set",i);return this},unset:function(h){if(!(h in this.attributes)){return this}this.fireEvent("check",this.attributes[h]);if(this.checked){return false}delete this.attributes[h];if(h==this.idAttribute){delete this.id}this.fireEvent("change:"+h).fireEvent("unset");return this},clear:function(){this.fireEvent("check");if(this.checked){return false}this.attributes={};return this},isNew:function(){return !this.id},has:function(h){return !!this.get(h)},get:function(h){return this.attributes[h]},toJSON:function(){return Object.clone(this.attributes)},sync:function(i,j){i||(i={});var h=i.onComplete;i.onComplete=function(k){if(j==="remove"){this.fireEvent("destroy",[k,this.model])}else{if(!this.set(k)){return false}}h&&h(k,this)}.bind(this);i=Object.append(this.options,i);if(i.onError){i.onError=i.onError.bind(this)}(c.Sync||d.sync)(this,j,i)},fetch:function(h){return this.sync(h,"get")},save:function(i,h){if(i&&!this.set(i,h)){return false}var j=this.isNew()?"add":"update";return this.sync(h,j)},destroy:function(h){return this.sync(h,"remove")}});var g=c.Model=b.extend({options:{record:a},init:function(h,i){i=this.setOptions(i).options;this.idAttribute=i.idAttribute;this.record=i.record;this._reset();if(h){this.refresh(h)}this.fireEvent("init",i)},_reset:function(h){this.length=0;this.records=[];this._byId={};this._byCid={};return this},_removeReference:function(h){if(this==h.model){delete h.model}return this},toJSON:function(){return Object.map(this.records,function(h){return h.toJSON()})},refresh:function(h,i){Object.each(this.records,this._removeReference,this);this._reset().add(h);this.fireEvent("refresh");return this},add:function(h,i){if(typeOf(h)==="array"){Array.each(h,function(j){this._add(j,i)},this)}else{this._add(h,i)}return this},_add:function(h,i){if(!h.idAttribute){h=this.record.initance(h,{model:this,idAttribute:this.idAttribute})}var j=this.getByCid(h);if(j){throw new Error(["Can't add the same model to a set twice",j.id])}this._byId[h.id]=h;this._byCid[h.cid]=h;if(!h.model){h.model=this}this.records.splice(this.length,0,h);this.length++;this.fireEvent("addRecord",[h,i]);return h},remove:function(h,i){if(typeOf(h)==="array"){Array.each(h,function(j){this._remove(j,i)},this)}else{this._remove(h)}return this},_remove:function(h,i){delete this._byId[h.id];delete this._byCid[h.cid];this.records.splice(this.records.indexOf(h),1);this.length--;this.fireEvent("removeRecord",[h,i]);this._removeReference(h);return h},get:function(h){if(h==null){return null}return this._byId[h.id!=null?h.id:h]},getByCid:function(h){return h&&this._byCid[h.cid||h]},clear:function(){var h=this.records.length-1;for(;h>=0;h--){this._remove(this.records[h])}return this},fetch:function(i){i||(i={});var h=i.onComplete,j=i.add?"add":"get";i.onComplete=function(k){this[i.add?"add":"refresh"](k,i);h&&h(k);this.fireEvent("getRecord")}.bind(this);i=Object.append(this.options,i);if(i.onError){i.onError=i.onError.bind(this)}(c.Sync||d.sync)(this,j,i)},create:function(i,k){k||(k={});if(!i.idAttribute){var j=i;i=this.record.initance(null,{model:this,idAttribute:this.idAttribute});if(!i.set(j)){return false}}else{i.model=this}var h=k.onComplete;k.onComplete=function(l){this.add(l);h&&h(l);this.fireEvent("createRecord",i)}.bind(this);i.save(null,k);return i}});var f=c.View=b.extend({options:{config:{tagName:"div",attrs:{"class":"ba"}}},init:function(h,i){h=this.setOptions(h).options;this.el=h.el?$(h.el):this.make(h.config);this.view_id=h.record_id;this.contains=$(h.contains);this.tpl=h.tpl;h.events&&this.delegateEvents(h.events,i);h.attrs&&this.render(h.attrs);this.fireEvent("init")},make:function(h){h.attrs||(h.attrs={});h.content||(h.content="");return new Element(h.tagName,h.attrs).set("html",h.content)},delegateEvents:function(i,j){var h=/^(\w+)\s*(.*)$/,j=j||this;Object.each(i,function(q,n){var m=n.match(h),p=$(this.el),l=m[1],k=m[2],o=typeOf(q)=="function"?q:j[q];if(k===""){o&&p.addEvent(l,function(r){o.call(j,this,r)})}else{o&&p.delegate(k,l,o,j,[this])}},this);return this},add:function(h){this.fireEvent("addView",h);this.contains&&this.render(h).el.inject(this.contains);return this},remove:function(h){$(this.el).destroy();this.fireEvent("removeView");return this},getTpl:function(h){var i=h||{};this.fireEvent("tpl");this.template=Mustache.to_html(this.tpl,i).replace(/^\s*/mg,"");return this.template},render:function(h){if(h&&h.idAttribute){h=h.toJSON()}this.el.set("html",this.getTpl(h));this.fireEvent("render",h);return this}});var e=c.Controller=b.extend({options:{model:c.Model,view:c.View},create:function(h,i){record=this.getRecord(h.view_id);record.unset("gid");this.add(record.toJSON(),i)},add:function(i,h){h=this.getOpt(h);this.model.create(i,Object.append(h.modelOpt,{route:this.route,onComplete:function(j){h.viewOpt.record_id=j[this.model.idAttribute];this.addView(j,h.viewOpt);this.fireEvent("add",j)}.bind(this)}));return this;this.fireEvent("add")},remove:function(i,j){j=this.getOpt(j);var h=this.model.get(i.view_id);h&&h.destroy(Object.append(j.modelOpt,{route:this.route,onComplete:function(k){i.remove();this.model.remove(h,j.modelOpt);delete this.viewItem[i.view_id];this.fireEvent("remove",k)}.bind(this)}));return this},init:function(h){h=Object.append(this.options,h);this.view=h.view;this.route=h.modelOpt.route;this.viewItem={};this.model=this.options.model.initance(null,h.modelOpt)},updateAttribute:function(j,k){var i=this.getRecord(j.view_id),h={};h[k.name]=k.value;i.set(h);this.update(j)},getRecord:function(h){return this.model.get(h)},update:function(i,j){j=this.getOpt(j);var h=this.getRecord(i.view_id);j.modelOpt.onComplete=function(k){i.render(k);this.fireEvent("update",k)};j.modelOpt.route=j.route||this.route;h.save(h,j.modelOpt)},getOpt:function(h){h=h||{};return{modelOpt:Object.append(this.options.modelOpt,h.modelOpt||{}),viewOpt:Object.append(this.options.viewOpt,h.viewOpt||{})}},fetch:function(h){h=this.getOpt(h);h.modelOpt=Object.append({onComplete:function(i){this.getView(this.model,h.viewOpt);this.fireEvent("fetch",i)}.bind(this)},h.modelOpt);this.model.fetch(h.modelOpt);return this},clear:function(h){this.viewItem&&Object.each(this.viewItem,function(i){this.remove(i)},this);return this},addView:function(j,i){var h=this.view.initance(i,this).add(j);this.viewItem[i.record_id]=h;return h},getView:function(i,h){i&&Object.each(i._byId,function(j,l){h.record_id=l;this.addView(j.toJSON(),h)},this)}})})();