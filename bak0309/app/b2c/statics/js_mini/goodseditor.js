var ShopExGoodsEditor=new Class({Implements:[Options],options:{periodical:false,delay:500,postvar:"finderItems",varname:"items",width:500,height:400},initialize:function(b,a){this.el=$(b);this.setOptions(a);this.cat_id=$("gEditor-GCat-input").get("value");this.type_id=$("gEditor-GType-input").get("value");this.goods_id=$("gEditor-GId-input").get("value");this.initEditorBody.call(this)},catalogSelect:function(b,c){b=b||1;var a=$("gEditor-GType-input");if(b!=a.get("value")){if(confirm(LANG_goodseditor.comfirm)||c<0){a.getElement("option[value="+b+"]").set("selected",true);this.updateEditorBody.call(this)}}this.cat_id=c},initEditorBody:function(){var c=this;var b=$("gEditor-GCat-category");var a=$("gEditor-GType-input");b&&b.addEvent("click",function(d){this.store("templabel",this.getElement(".label").get("text"));this.store("tempvalue",$("gEditor-GCat-input").get("value"));a.store("tempvalue",a.get("value"))});a.addEvent("focus",function(){this.store("tempvalue",this.get("value"))});a.addEvent("change",function(g){var d=this.retrieve("tempvalue");var f;if(b){f=b.retrieve("templabel")}if(this.get("value")&&confirm(LANG_goodseditor.comfirm)){c.updateEditorBody.call(c);c.type_id=this.get("value")}else{this.getElement("option[value="+d+"]").set("selected",true);if(f){b.getElement(".label").set("text",f)}$("gEditor-GCat-input").set("value",b.retrieve("tempvalue"))}})},updateEditorBody:function(b){try{if($("productNode")&&$("productNode").retrieve("specOBJ")){$("productNode").appendChild($("productNode").retrieve("specOBJ").toHideInput($("productNode").getElement("tr")))}}catch(c){}var a={method:"post",data:$("gEditor").toQueryString(),url:"index.php?app=b2c&ctl=admin_goods_editor&act=update",evalScripts:false,onComplete:function(f){var e={"#menu-desktop":$("menu-desktop"),"#gEditor-Body":$("gEditor-Body")};f=f.replace(/<\!-{5}(.*?)-{5}([\s\S]*?)-{5}(.*?)-{5}>/g,function(){var h=arguments[1];h=e[h]||$(h);var g=arguments[2]||null;if(g&&h){h.empty().set("html",g).fixEmpty()}return""});var d="";this.response.text.replace(/<script[^>]*>([\s\S]*?)<\/script>/gi,function(g,h){d+=h+"\n";return""});Browser.exec(d);goodsEditFrame()}};new Request(a).send()},mprice:function(b){for(var c=$(b).getParent();c.tagName!="TR";c=c.getParent()){}var a={};c.getElements("input").each(function(d){if(d.name=="price[]"){a.price=d.value}else{if(d.name=="goods[product][0][price]"){a.price=d.value}else{if(d.getAttribute("level")){a["level["+d.getAttribute("level")+"]"]=d.value}}}});window.fbox=new Dialog("index.php?app=b2c&ctl=admin_goods_editor&act=set_mprice",{title:LANG_goodseditor.editvipprice,ajaxoptions:{data:a,method:"post"},modal:true});window.fbox.onSelect=goodsEditor.setMprice.bind({base:goodsEditor,el:c})},setMprice:function(a){var b={};a.each(function(c){b[c.name]=c.value});this.el.getElements("input").each(function(c){var e=c.getAttribute("level");if(e&&b[e]!=undefined){c.value=b[e]}})},spec:{addCol:function(b,a){this.dialog=new Dialog("index.php?app=b2c&ctl=admin_products&act=set_spec&_form="+(b?b:"goods-spec")+"&p[0]="+a,{ajaxoptions:{data:$("goods-spec").toQueryString()+($("nospec_body")?"&"+$("nospec_body").toQueryString():""),method:"post"},title:LANG_goodseditor.type})},addRow:function(){this.dialog=new Dialog("index.php?app=b2c&ctl=admin_goods_editor/spec&act=addRow",{ajaxoptions:{data:$("goods-spec"),method:"post"}})}},adj:{addGrp:function(a){this.dialog=new Dialog("index.php?app=b2c&ctl=admin_goods_editor&act=addGrp&goods_id="+this.goods_id+"&_form="+(a?a:"goods-adj"),{title:LANG_goodseditor.widget})}},pic:{del:function(d){if(confirm(LANG_goodseditor.comfirmDelPic)){d=$(d);var a=d.getParent(".gpic-box"),b=a.getNext(".gpic-box");try{if(d.get("ident")){if($$("#all-pics input[name=image_default]")[0]){$$("#all-pics input[name=image_default]")[0].value=d.get("ident")}$("all-pics").eliminate("cururl");a.destroy()}}catch(c){a.destroy()}if(b){b.getElement(".gpic").onclick()}}},setDefault:function(g,e){var b=$(e).getParent(".pic-main");var c=b.getElement(".pic-area");var d=$E(".gpic[image_id="+g+"]",c);if(d.hasClass("current")){return}var f,a;if(f=$E(".current",c)){f.removeClass("current")}if(a=$E("input[name=image_default]",c)){a.set("value",g)}d.addClass("current")},getDefault:function(){var a=obj.getParent(".pic-main");var b=a.getElement(".pic-area");var c=$E("input[name=image_default]",b);if(c){return c.value}else{return false}},viewSource:function(a){return new Dialog(a,{title:LANG_goodseditor.viewSource,singlon:false,width:650,height:300})}},rateGoods:{add:function(){window.fbox=new Dialog("index.php?ctl=goods/product&act=select",{modal:true,ajaxoptions:{data:{onfinish:"goodsEditor.rateGoods.insert(data)"},method:"post"}})},del:function(){},insert:function(a){$$("div.rate-goods").each(function(b){a["has["+b.getAttribute("goods_id")+"]"]=1});new Request({url:"index.php?ctl=goods/product&act=ratelist",data:a,onComplete:function(b){$("x-rate-goods").innerHTML+=b}}).send()}}});var CatalogSelect=new Class({Implements:[Events,Options],options:{updateMain:"catalog-x",url:"index.php?app=b2c&ctl=admin_goods_cat&act=get_subcat_list",childClass:".subs",params:"p[0]"},initialize:function(c,a){if(!c){return}this.handle=$(c);this.setOptions(a);var b=this.options;this.url=b.url;this.updateMain=$(b.updateMain);if(!this.updateMain||!this.url){return}this.cacheHS={};this.load.call(this)},load:function(){this.request("0")},attach:function(){var a=this;this.updateMain.getElements(this.options.childClass).addEvent("click",function(b){var c=this.get("id")||this.get("pid");if(this.hasClass("cat-no-child")){a.callback("",this.get("text"));return document.body.fireEvent("click",b)}return a.isCache(c)});this.updateMain.getElements(".cat-child").addEvent("click",function(c){var b=this.getParent("*[type_id]");if(!b){return}a.callback(b.id,this.get("text"),b.get("type_id"));document.body.fireEvent("click",c)})},isCache:function(a){this.cacheHS.id?this.updateMain.innerHTML=this.getCache(a):this.request(a);this.fireEvent("show").attach.call(this)},request:function(){var c=this;var b=Array.flatten(arguments);var a=b.link({options:Object.type,id:String.type});a.options=Object.append(a.options||{},{url:this.url,data:this.options.params+"="+a.id,method:"get",onComplete:function(d){c.updateMain.innerHTML=d;c.setCache(a.id,d).attach();c.fireEvent("show")}});new Request(a.options).send();return this},callback:function(d,c,a){var b=this.handle.getElement(".label").set("text",c);if(this.handle.getElement("input[type=hidden]")){this.handle.getElement("input[type=hidden]").value=d}this.fireEvent("callback",[d,a,c])},setCache:function(b,a){if(this.cacheHS[b]==undefined){this.cacheHS[b]=a}return this},getCache:function(a){return this.cacheHS[a]}});