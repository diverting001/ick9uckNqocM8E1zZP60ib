var AlbumZoom=new Class({Implements:[Events,Options],options:{wrap:".product-album-preview",preview:".album-preview-container",zooms:".album-zooms-container",handle:".album-zooms-handle",bigImages:".album-big-image",midImages:".album-mid-image",thumbs:".product-album-thumb",thumbEvent:"mouseover",zoomable:true,zoomsSize:{x:450,y:450}},initialize:function(a,c){a=this.container=$(a);this.setOptions(c);this.album_big_img=$$(this.options.bigImages);this.album_mid_img=$$(this.options.midImages);this.recalculating=false;this.wrap=this.container.getElement(this.options.wrap);this.preview=this.container.getElement(this.options.preview);this.previewImg=this.preview.getElement("img");this.zooms=$(this.options.zooms)||$$(this.options.zooms)[0];this.zoomsImg=this.zooms?this.zooms.getElement("img"):null;this.thumbs=this.container.getElement(this.options.thumbs);this.zoomsImgX=0;this.zoomsImgY=0;this.previewImgX=0;this.previewImgY=0;this.handleX=20;this.handleY=20;this.positionX=0;this.positionY=0;var b="";var e="";var d=this.container.getElement("img.loading");if(d.alt!=""){b=d.alt}e=d.src;this.loadingCont=new Element("div.loading",{html:'<img alt="loading..." src="'+e+'" /> '+b,styles:{visibility:"hidden"}}).inject(this.wrap);this.baseuri="";this.safariOnLoadStarted=false;this.checkcoords_ref=this.checkcoords.bind(this);this.findZooms()},findSelectors:function(){var h=this.thumbs.getElements("li");if(!h.length){return}var f=this.thumbs.getElement("ul");var d=this.thumbs.getElement(".prev");var e=this.thumbs.getElement(".next");var c=h[0].getSize().x+h[0].getPatch("margin").x;var a=c*h.length;var g=this.thumbs.getSize().x;if(a>g){e.removeClass("over")}$$(d,e).addEvent("mousedown",function(j){var k=parseInt(f.getStyle("margin-left"))||0;if(this.hasClass("over")){return}new Fx.Tween(f,{duration:100,onComplete:function(){k=parseInt(f.getStyle("margin-left"));if(k<0){d.removeClass("over")}else{if(k>=0){d.addClass("over")}}if(k<=g-a){e.addClass("over")}else{if(k>g-a){e.removeClass("over")}}}}).start("margin-left",k,k+(this.hasClass("backward")?-1:1)*c)});var b=this.thumbs.getElements("a[rev]");var i=this;b.each(function(k,j){k.addEvent("click",function(l){l.stop()});k.addEvent(i.options.thumbEvent,function(l){this.getParent("li").addClass("active").getSiblings(".active").removeClass("active");i.replaceZoom(k)});if(i.options.zoomable){i.album_big_img[j]=i.album_big_img[j]||new Element("img"+i.options.bigImages,{src:k.href}).inject(document.body)}i.album_mid_img[j]=i.album_mid_img[j]||new Element("img"+i.options.midImages,{src:k.rev}).inject(document.body)})},findZooms:function(){var b=this.preview;var a=this.previewImg;if(!a){return}b.addEvent("click",function(c){c.stop()});if(Browser.ie){b.setStyle("z-index",0)}if(this.options.zoomable){this.zooms=this.zooms||new Element("div"+this.options.zooms,{styles:{width:this.options.zoomsSize.x,height:this.options.zoomsSize.y}}).inject(document.body);this.zoomsImg=this.zoomsImg||new Element("img",{src:b.href}).inject(this.zooms);this.initZoom()}this.findSelectors()},initHandle:function(){this.handle=new Element("div"+this.options.handle);this.recalculateHandleDimensions();this.handle.inject(this.preview);this.preview.unselectable="on";this.preview.onselectstart=Function.from(false)},initZoomsContainer:function(){var a=this.zoomsImg.src;this.zooms.innerHTML="";this.zoomsImg=new Element("img",{src:a}).inject(this.zooms)},initZoom:function(){if(this.loadingCont!=null&&!this.zoomsImg.complete&&this.previewImg.width!=0&&this.previewImg.height!=0){var c=this.container.getElement(".product-album-preview");this.loadingCont.setStyles({left:(c.getSize().x-this.loadingCont.getSize().x)/2,top:(c.getSize().x-this.loadingCont.getSize().y)/2,visibility:"visible"})}if(Browser.safari){if(!this.safariOnLoadStarted){this.zoomsImg.addEvent("load",this.initZoom.bind(this));this.safariOnLoadStarted=true;return}}else{if(Browser.ie){this.preview.setStyle("z-index",1)}if(Browser.name!="unknown"){if(!this.zoomsImg.complete||!this.previewImg.complete){this.initZoom.delay(100,this);return}}}this.zoomsImgX=this.zoomsImg.width;this.zoomsImgY=this.zoomsImg.height;this.previewImgX=this.previewImg.width;this.previewImgY=this.previewImg.height;if(this.zoomsImgX==0||this.zoomsImgY==0||this.previewImgX==0||this.previewImgY==0){var d=this.thumbs.getElements("a[rev]");if(!d){this.initZoom.delay(100,this);return}else{var a;d.each(function(g,f){var e=g.getParent("li");if(e.hasClass("active")){a=g}});a=a||d[0];this.options.zoomable=true;this.replaceZoom(a,"isInit")}}if(this.loadingCont!=null){this.loadingCont.setStyle("visibility","hidden")}var b=this.preview.getParent(".product-album-preview");this.zoomsX=b.getPosition().x+b.getSize().x+10;this.zooms.setStyles({"left":this.zoomsX,"top":b.getPosition().y});if(this.handle){this.recalculateHandleDimensions();return}this.initZoomsContainer();this.initHandle();document.addEvent("mousemove",this.checkcoords_ref);this.preview.addEvent("mousemove",this.mousemove.bind(this))},replaceZoom:function(c,b){if(c.rev==this.previewImg.src&&b!="isInit"){return}this.previewImg.src=c.rev;if(this.options.zoomable){var a=new Element("img",{src:c.href});a.replaces(this.zoomsImg);this.zoomsImg=a;this.safariOnLoadStarted=false;this.initZoom()}},stopZoom:function(){document.removeEvent("mousemove",this.checkcoords_ref)},checkcoords:function(f){var d=f.page;var b=d.x;var h=d.y;var c=this.previewImg.getPosition();var a=c.x;var g=c.y;if(b>a+this.previewImgX||b<a||h>g+this.previewImgY||h<g){this.hiderect();return false}if(Browser.ie){this.preview.setStyle("z-index",1)}return true},mousemove:function(g){g.stop();if(this.recalculating||!this.checkcoords(g)){return}this.recalculating=true;var c=this.previewImg;var f=g.page;var b=f.x;var i=f.y;var d=c.getPosition();var a=d.x;var h=d.y;this.positionX=b-a;this.positionY=i-h;if((this.positionX+this.handleX/2)>=this.previewImgX){this.positionX=this.previewImgX-this.handleX/2}if((this.positionY+this.handleY/2)>=this.previewImgY){this.positionY=this.previewImgY-this.handleY/2}if((this.positionX-this.handleX/2)<=0){this.positionX=this.handleX/2}if((this.positionY-this.handleY/2)<=0){this.positionY=this.handleY/2}setTimeout(this.showrect.bind(this),16)},showrect:function(){var b=parseInt(this.positionX-this.handleX/2);var a=parseInt(this.positionY-this.handleY/2);this.handle.setStyles({left:b,top:a,visibility:"visible"});perX=b*(this.zoomsImgX/this.previewImgX);perY=a*(this.zoomsImgY/this.previewImgY);this.zoomsImg.setStyles({left:-perX,top:-perY,visibility:"visible"});this.zooms.setStyles({left:this.zoomsX,visibility:"visible"});this.recalculating=false},hiderect:function(){if(this.handle){this.handle.setStyle("visibility","hidden")}this.zooms.setStyles({left:-10000,visibility:"hidden"});if(Browser.ie){this.preview.setStyle("z-index",0)}},recalculateHandleDimensions:function(){this.handleX=(this.zooms.getSize().x-3)/(this.zoomsImgX/this.previewImgX);this.handleY=(this.zooms.getSize().y-3)/(this.zoomsImgY/this.previewImgY);if(this.handleX>this.previewImgX){this.handleX=this.previewImgX}if(this.handleY>this.previewImgY){this.handleY=this.previewImgY}this.handle.setStyles({width:this.handleX,height:this.handleY})}});var LayoutRequest=new Class({Implements:[Events,Options],options:{threshold:50,loadCls:"loading",errorCls:"error",completeCls:"",onRequest:function(c){var b,a=this.options.loadCls;if(b=c.update){b.addClass(a)}if(b=c.append){new Element("div",{"data-load":c.name,"class":a}).inject(b)}},onFailure:function(a){var c,b=this.options.loadCls,d=this.options.errorCls;if((c=a.append)){c=c.getElement("div[data-load="+a.name+"]")}if(a.update){c=a.update}c.removeClass(b)},onComplete:function(a){var c,b=this.options.loadCls,d=this.options.errorCls;if((c=a.append)){c=c.getElement("div[data-load="+a.name+"]")}c&&c.destroy();if((c=a.update)){c.removeClass(b).removeClass(d)}},onSuccess:function(){}},initialize:function(b,a){if(!b.length){return}this.sync_queue=b;this.setOptions(a).fireEvent("load");this.initEvent()},initEvent:function(){var c,b=this;this.cur_sync={},win=window;win.addEvent("domready",function(){b.progress.call(b,b.sync_queue)});if(!this.sync_queue.length){return}win.addEvents({"scroll":a,"resize":a});function a(){if(c){return}c=function(){b.progress.call(b,b.sync_queue);if(!b.sync_queue.length){win.removeEvent("scroll",a).removeEvent("resize",a)}c=null}.delay(200)}},progress:function(a){if(!a.length){return this}var b=[],c=[];a.each(function(d){if(!d.require){return b.push(d)}c.push(d)});!!b.length&&b.each(this.filterSync,this);!!c.length&&this.require(c,a)},filterItems:function(b){var g=(b.update||b.append).getOffsets().y,e,d=window,c=d.getScroll(),a,f=d.getSize().y;if(e=b.append){g+=e.getSize().y}if(a=this.options.threshold){g-=a}return g<=c.y+f?true:false},filterSync:function(a){if(!a.update&&!a.append){return this.sync_queue.erase(a)}this.filterItems(a)&&this.request(a)},require:function(b,a){b.each(function(c){var d=this.cur_sync[c.require];if(d&&d.running){return d.ajaxCb=function(){return this.filterSync(c)}}if(d=="complete"){this.filterSync(c)}},this)},request:function(g){if(!g){return}var f=g.onSuccess||function(){},a=g.onFailure||function(){},b=g.onRequest||function(){},h=this,c=2,e=h.cur_sync[g.name];var i=$(g.name);if(i){if(g.update){g.update=i}else{g.append=i}}if(!i&&this.detail){return this.sync_queue.erase(g)}var d=g.view?"&view="+g.view:"";if(e&&e.running){return this}return this.cur_sync[g.name]=new Request.HTML(Object.append(g,{timeout:30000,data:"invalid_post_data=1"+d,onTimeout:function(j){this.cancel();if(!c){return h.fireEvent("failure",g).complete(g)}c-=1;this.send()},onRequest:function(){h.fireEvent("request",g);b.apply(h,arguments)},onFailure:function(){h.fireEvent("failure",g);a.apply(h,arguments);h.failure.call(h,g)},onSuccess:function(j){h.fireEvent("complete",g);f.apply(h,arguments);h.complete.call(h,g);if(this.ajaxCb){this.ajaxCb.call(h)}}})).send()},complete:function(a){this.cur_sync[a.name]="complete";this.sync_queue.erase(a);if(!this.sync_queue.length){this.success()}},failure:function(a){this.cur_sync[a.name]="failure";this.sync_queue.erase(a).each(function(b){if(b.require==a.name){delete b.require;this.filterSync(b)}},this)},success:function(){this.fireEvent("success")}});