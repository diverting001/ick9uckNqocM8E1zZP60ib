var DragDropPlus=new Class({Implements:[Options,Events],options:{},initialize:function(b,c,a){this.dragSelecterString=b;this.dropSelecterString=c;this.drags=$$(b);this.drops=$$(c);this.setOptions(a);this.drag_operate_box=$("drag_operate_box");if(!this.drag_operate_box){return}this.drag_operate_box.store("lock",false);this.drag_handle_box=this.drag_operate_box.getElement(".drag_handle_box");this.drag_rules=this.drag_operate_box.getElement(".drag_rules");this.scrollFx=new Fx.Scroll(document,{fps:50,duration:200,link:"cancel"});this.dobFx=new Fx.Morph(this.drag_operate_box,{fps:50,duration:150,link:"cancel"});this.dhbFx=new Fx.Morph(this.drag_handle_box,{fps:50,duration:150,link:"cancel"});this.rsFx=new Fx.Morph(this.drag_rules,{fps:50,duration:150,link:"cancel"});this.dragSign=$("drag_ghost_box").inject(document.body);this.fireEvent("onInit",this);this.initDOBBase(this.drops);this.initDrags(this.drags);this.initDrops(this.drops)},checkEmptyDropPanel:function(b){if(!b||!b.hasClass(this.dropSelecterString.substring(1,this.dropSelecterString.length))){return}if(!b.getElement(this.dragSelecterString)){if(!b.getElement(".empty_drop_box")){var a=new Element("div.empty_drop_box").set("html",'&nbsp;<button type="button" class="btn btn-add-widgets"><span><span><i class="icon"></i>添加挂件</span></span></button>').inject(b);a.addEvent("click",function(c){this.fireEvent("add",[a],this)}.bind(this));if(this.dragmoveInstance){b.store("droppanel",true);this.dragmoveInstance.droppables.include(b)}}}else{if(b.getElement(".empty_drop_box")){b.getElement(".empty_drop_box").destroy()}}},dragLeave:function(){},dargInject:function(d,b){var c=this.dragging;if(!c){return}var a="inside";if(!b.retrieve("droppanel")){a=c.getAllPrevious().contains(b)?"before":"after"}c.inject(b,a);this.checkEmptyDropPanel(d.retrieve("droped"));this.checkEmptyDropPanel(b);d.store("droped",b);this.dragSign.setStyles(c.getCoordinates())},getDropables:function(){var b=this.dragging;var a=Array.from(this.drags).erase(b).combine(this.drops.filter(function(c){if(c.getElement(this.dragSelecterString)){c.store("droppanel",false);return false}else{c.store("droppanel",true);return true}}.bind(this)));return a},initDOBBase:function(e){var c=this.drag_operate_box;var b=this.drag_handle_box;var d=this;if(!e){return}var a=b.getElements(".btn-up-slot,.btn-down-slot");a.addEvent("click",function(i){var g=c.retrieve("drag");var f=g.getParent().getChildren();var h=g[this.hasClass("btn-up-slot")?"getPrevious":"getNext"]();if(!h){return}i.stop();var j=new Fx.Sort(f,{duration:250,mode:"vertical",link:"chain",onComplete:function(){j.rearrangeDOM();document.body.fireEvent("mouseover",{target:g});d.fireEvent("upDown",[c.retrieve("drag")],d)}}).swap(g,h)});b.getElement(".btn-edit-widgets").addEvent("click",function(f){f.stop();this.fireEvent("edit",[c.retrieve("drag")],this)}.bind(this));c.addEvent("dblclick",function(f){f.stop();this.fireEvent("edit",[c.retrieve("drag")],this)}.bind(this));b.addEvent("dblclick",function(f){f.stop()}.bind(this));b.getElement(".btn-del-widgets").addEvent("click",function(f){f.stop();this.fireEvent("delete",[c.retrieve("drag")],this)}.bind(this));b.getElements("li").addEvent("click",function(f){f.stop();this.fireEvent("add",[c.retrieve("drag"),$(f.target)],this)}.bind(this))},initDrags:function(b){var f=this;var e=this.drag_operate_box;var c=this.drag_handle_box;var d=this.drag_rules;var a;document.body.addEvents({mouseover:function(j){j=$(j.target);var i=j.getParent(f.dragSelecterString);var h=235;if(!i&&!j.hasClass(f.dragSelecterString.substr(1))){return}if(e.retrieve("lock")){return}i=i||j;f.fireEvent("initDrags",[i,b],f);c.set("title",i.get("title")||"&nbsp;");e.setStyle("visibility","visible");e.store("drag",i);a=i.getCoordinates();a=Object.append(a,{top:a.top-c.getSize().y,height:a.height-e.getPatch().y+c.getSize().y,width:a.width-e.getPatch().x});delete a.bottom;delete a.right;var g=h+e.getPatch().x;f.dhbFx.start({left:a.left+g+e.getStyle("border-left").toInt()>document.body.getSize().x&&!Browser.ie6?a.width-g:0});f.dobFx.start(a);c.getElements(".btn-up-slot,.btn-down-slot").removeClass("disabled");if(!i.getPrevious()){c.getElement(".btn-up-slot").addClass("disabled")}if(!i.getNext()){c.getElement(".btn-down-slot").addClass("disabled")}}});c.addEvents({mouseenter:function(h){if(a&&a.width>=50){d.show().getElement(".drag_annotation").setStyle("width",a.width-d.getElement(".drag_left_arrow").getSize().x*2).getElement("em").set("text",a.width+e.getPatch().x+"px");var g=20;f.rsFx.cancel();f.rsFx.start({height:g,"line-height":g})}},mouseleave:function(g){if(a&&a.width>=50){f.rsFx.cancel();f.rsFx.start({height:0,"line-height":0})}}});window.addEvent("domready",function(){b.each(function(g){f.checkEmptyDrag(g);g.getElements("form").removeEvents().addEvent("submit",function(h){h.stop()});g.getElements("a").removeEvents().addEvent("click",function(h){h.stop()})})})},checkEmptyDrag:function(a){if(!a.getOuterSize().y){this.fireEvent("emptyDrag",[a],this)}},initDrops:function(a){a.each(function(b,c){this.checkEmptyDropPanel(b);this.fireEvent("initDrops",[b,a],this)},this)}});