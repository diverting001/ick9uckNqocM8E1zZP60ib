var Widgets=new Class({Extends:DragDropPlus,initialize:function(b,c,a){this.parent(b,c,a);this.drags.each(function(d){if(d.getProperty("ishtml")){d.getElement(".content-html").set("html",d.getElement(".content-textarea").get("value"))}})},inject:function(a,b){this.addWidget(this.curEl,a,b||this.theme)},ghostDrop:function(b,d){b=typeOf(b)==="string"?JSON.decode(b):b;this.drag_operate_box.setStyle("visibility","hidden").store("lock",true);$("tempDropBox")&&$("tempDropBox").destroy();this.tempDropBox=new Element("div",{id:"tempDropBox"}).inject(document.body);try{var a=this.drag_operate_box.retrieve("drag");this.tempDropBox.empty();this.addWidget(a,b,d);this.drag_operate_box.store("lock",false)}catch(c){alert(JSON.encode(c))}document.body.addEvent("contextmenu",function(g){g.stop();$("tempDropBox")&&$("tempDropBox").destroy();this.drag_operate_box.store("lock",false);document.body.removeEvent("contextmenu",arguments.callee)}.bind(this))},copyWidgets:function(a){},addWidget:function(a,b,d){var c={modal:true,title:LANG_shopwidgets.addWidget+(b.label||""),ajaxoptions:{render:false},width:0.7,height:0.7};this.curdialog=new top.Dialog(top.SHOPADMINDIR+"index.php?&app=site&ctl=admin_theme_widget&act=do_add_widgets&widgets="+b.name+"&widgets_app="+b.app+"&widgets_theme="+b.theme+"&theme="+d,c);this.curDrop=a},editWidget:function(a){var b={modal:true,title:LANG_shopwidgets.editWidget+(a.label||a.title),ajaksable:false,width:0.7,height:0.7};this.curWidget=$(a);if(a.get("ishtml")){return this.curdialog=new top.Dialog(top.SHOPADMINDIR+"index.php?ctl=content/pages&act=editHtml",Object.merge(b,{ajaksable:true,ajaxoptions:{method:"post",data:"htmls="+encodeURIComponent(a.getElement(".content-html").get("html").clean().trim())},title:LANG_shopwidgets.editHTML}))}return this.curdialog=new top.Dialog(top.SHOPADMINDIR+"index.php?app=site&ctl=admin_theme_widget&act=do_edit_widgets&widgets_id="+a.get("widgets_id")+"&theme="+a.get("widgets_theme"),b)},delWidget:function(b){var c=this.drag_operate_box;c.setStyle("visibility","hidden").store("lock",true);var a=b.getParent();new Fx.Tween(b).start("opacity",0).chain(function(){b.destroy();c.store("lock",false);this.checkEmptyDropPanel(a);top.document.id("btn_save")&&(top.document.id("btn_save").disabled=false)}.bind(this))},preview:function(a,c){var e=[];var d=this.drops;var b={};d.each(function(i,g){var h=i.getElements(".shopWidgets_box");h.each(function(k){e.push(("widgets[{widgetsId}]={baseFile}:{baseSlot}:{baseId}").substitute({widgetsId:k.get("widgets_id"),baseFile:this.bf,baseSlot:this.bs,baseId:this.bi}));if(k.get("ishtml")){var j=k.getElement(".content-html");e.push(("html[{widgetsId}]={htmls}").substitute({widgetsId:k.get("widgets_id"),htmls:encodeURIComponent(j.get("html"))}))}},{mce:this.mce,bf:i.get("base_file"),bs:i.get("base_slot"),bi:i.get("base_id")});b[i.get("base_file")]=1}.bind(this));for(f in b){e.push(("files[]={file}").substitute({file:f}))}new Request({url:a,method:"post",data:e.join("&"),onRequest:function(){$(c).set({disabled:true,html:"<span><span>正在生成预览...</span></span>"})},onComplete:function(i){i=JSON.decode(i);$(c).set({disabled:false,html:"<span><span>预览模板</span></span>"});if(i&&i.success){var h=$("_temp_preview_link")||new Element("a#_temp_preview_link.hide",{target:"preview",href:i.url||top.PREVIEW_URL}).inject(document.body);if(document.createEvent){var g=document.createEvent("MouseEvent");g.initEvent("click",false,false);h.dispatchEvent(g)}else{h.click()}}}}).send()},saveAll:function(b,e){var d=[];var c=this.drops;var a={};c.each(function(i,g){var h=i.getElements(".shopWidgets_box");h.each(function(k){d.push(("widgets[{widgetsId}]={baseFile}:{baseSlot}:{baseId}").substitute({widgetsId:k.get("widgets_id"),baseFile:this.bf,baseSlot:this.bs,baseId:this.bi}));if(k.get("ishtml")){var j=k.getElement(".content-html");d.push(("html[{widgetsId}]={htmls}").substitute({widgetsId:k.get("widgets_id"),htmls:encodeURIComponent(j.get("html"))}))}},{mce:this.mce,bf:i.get("base_file"),bs:i.get("base_slot"),bi:i.get("base_id")});a[i.get("base_file")]=1}.bind(this));for(f in a){d.push(("files[]={file}").substitute({file:f}))}new Request({url:top.SHOPADMINDIR+"index.php?app=site&ctl=admin_theme_widget&act=save_all",method:"post",data:d.join("&"),onRequest:function(){new top.MessageBox(LANG_shopwidgets.saving)},onSuccess:function(g){b&&b.call(e||this,this);try{g=JSON.decode(g);for(dom in g){if($(dom)&&g[dom]){$(dom).set("widgets_id",g[dom])}}top.MessageBox.success(LANG_shopwidgets.saveSuccess)}catch(h){top.MessageBox.error(LANG_shopwidgets.saveError+h.message)}}.bind(this)}).send()}});window.addEvent("domready",function(){this.shopWidgets=new Widgets(".shopWidgets_box",".shopWidgets_panel",{onInit:function(){this.theme=top.THEME_NAME||""},onEdit:function(b,a){shopWidgets.editWidget(b)},onDelete:function(a){if(top.confirmDialog){top.confirmDialog(LANG_shopwidgets.comfirmDel,function(){this.delWidget(a)}.bind(this))}else{if(confirm(LANG_shopwidgets.comfirmDel)){this.delWidget()}}},onAdd:function(c,b){var d=this.drag_operate_box;var a=b?b.get("class")||"":"";d.store("lock",true);shopWidgets.widgetsDialog=new top.Dialog(top.SHOPADMINDIR+"index.php?app=site&ctl=admin_theme_widget&act=add_widgets_page&theme="+this.theme,{width:770,height:500,title:"添加挂件",modal:true,resizeable:false,onShow:function(g){this.dialog_body.id="dialogContent";shopWidgets.injectWhere=a;if(c.hasClass("empty_drop_box")){shopWidgets.injectBox=c.getParent()}else{shopWidgets.injectBox=null}},onClose:function(){d.store("lock",false)}})},onUpDown:function(b,a){top.document.id("btn_save")&&(top.document.id("btn_save").disabled=false)},onEmptyDrag:function(a){new Element("div.empty_drag_box",{html:"(TEMP DATA)"}).inject(a)}})});