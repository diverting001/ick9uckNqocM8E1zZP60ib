<form action="index.php?app=shangou&ctl=admin_events_cat&act=update" id="catEditor" method="post">
    <{area inject=".mainHead"}>
		<h2 class="head-title"><{t}>活动频道<{/t}></h2>
        <div class="gridlist-action">
        <{assign var=addcat value=$___shangou="添加频道"|t:'shangou'}>
		<{assign var=editsort value=$___shangou="编辑排序"|t:'shangou'}>
		<{assign var=savesort value=$___shangou="保存排序"|t:'shangou'}>
            <{button app="desktop" label=$addcat icon="btn_add.gif" onclick="new Dialog('index.php?app=shangou&ctl=admin_events_cat&act=addnew',{title:'{$addcat}',width:600,height:450})" }>
            <{button app="desktop" tmplabel=$savesort label=$editsort  id="edit-catsort"}>

<{if $tree_number<=1000}> <{button app="desktop" label=$___shangou="展开频道"|t:'shangou' id="showCat-handle"}> <{button app="desktop" label=$___shangou="收起频道"|t:'shangou'  id="hideCat-handle" }><{/if}>
            &nbsp;
        </div>
        <div class="Node">
        <div class='gridlist-head mainHead '>
        <table width="100%" border="0" cellpadding="0" cellspacing="0">
        <tr>
        <td width="20%"><{t}>频道名称<{/t}></td>
        <td width="22%"><{t}>类型<{/t}></td>
		<td width="8%"><{t}>排序<{/t}></td>
		<td width="35%"><{t}>操作<{/t}></td>
        </tr></table>
       </div>
       </div>
    <{/area}>
    <div class="Node-body">
    <div id="cat_tree" class='gridlist catlist'>
    <{foreach from=$tree item=item name="item"}>
        <div style="padding:0" depath="<{$item.step}>" class="clear_cat row" cid="<{$item.cat_id}>" pid="<{$item.pid}>">
            <div class='row-line' style="padding:0">
             <table cellpadding="0" cellspacing="0" border="0">
            <tr>
            <td width="20%" style="vertical-align:top">
              <div style="padding-left:<{$item.step*15}>px;text-align:left">
                <{if $tree_number<=1000}>
                <{if $item.cls=='true'}>
                <span class="handle-icon" style='width:12px;line-height:12px; height:12px;overflow:hidden;display:inline-block;padding:0;cursor:pointer'>
                  <{img src="bundle/handle-hide.gif" alt=$___shangou="收起子频道"|t:'shangou' title=$___shangou="收起子频道"|t:'shangou' class="handle-hide" app='desktop'}>
                  <{img src="bundle/handle-show.gif" alt=$___shangou="收起子频道"|t:'shangou' title=$___shangou="展开子频道"|t:'shangou' class="handle-show" app='desktop'}>
                </span>
                <{/if}>
                <{/if}>
                <a href="index.php?app=shangou&ctl=admin_events_cat&act=edit&p[0]=<{$item.cat_id}>" target="dialog::{title:'<{t}>编辑频道<{/t}>', width:600, height:450}">
	                    	<{$item.cat_name}>
						</a>
			   </div>

               </td>

                <td width="22%" style="vertical-align:top"><span class="quiet"><{if $item.type_name}>[<{$item.type_name}>]<{/if}></span></td>
                <td width="8%" align="center" style="vertical-align:top">
                    <input class="_x_ipt" type="number" size="5"  name="p_order[<{$item.cat_id}>]" value="<{$item.p_order|default:0}>" vtype="unsigned" style="display:none"><b><{$item.p_order|default:0}></b>
                </td>
                <td width="35%" style="vertical-align:top">
	                  <div class="clearfix">
		 				   <div class="span-auto">&nbsp;</div>
						   <div class="span-auto">&nbsp;</div>
	                  	   <div class="span-auto">
	                  	   	<{assign var="cat_id" value=$item.cat_id}>
	<span class="opt" onClick="new Dialog('index.php?app=shangou&ctl=admin_events_cat&act=addnew&p[0]=<{$item.cat_id}>', {title:'<{t}>添加子频道<{/t}>', width:600, height:450})">
		<{img src="bundle/addcate.gif" border="0" alt=$___shangou="添加子频道"|t:'shangou' app='desktop'}>
		<{t}>增加子类<{/t}></span>
	                  	   </div>
						   <div class="span-auto">
							     <span class="opt" onClick="new Dialog('index.php?app=shangou&ctl=admin_events_cat&act=edit&p[0]=<{$item.cat_id}>',{title:'<{t}>编辑频道<{/t}>', width:600, height:450})"><{img src="bundle/editcate.gif" border="0" alt=$___shangou="编辑"|t:'shangou'  app='desktop'}><{t}>编辑<{/t}></span>
						   </div>
						   <div class="span-auto">
						   <span class="opt" onclick="deleteRow('index.php?app=shangou&ctl=admin_events_cat&act=toRemove&p[0]=<{$item.cat_id}>',event)"><{img src="bundle/delecate.gif" border="0" alt=$___shangou="删除"|t:'shangou' app='desktop'}><{t}>删除<{/t}></span>
						   </div>
						   <div class="span-auto">
							<span class="opt" onclick='W.page("index.php?app=shangou&ctl=admin_events&act=index&filter[cat_id]=<{$item.link.cat_id.v}>")'><{img src="bundle/showcate.gif" border="0" alt=$___shangou="查看此频道下闪购活动"|t:'shangou' app='desktop'}><{t}>查看闪购活动<{/t}></span>
						   </div>
						   <div class="span-auto last">
							<span class="opt" onclick="window.open('<{$item.url}>')"><{img src="bundle/zoom_btn.gif" border="0" alt=$___shangou="跳转前台查看该"|t:'shangou' app='desktop'}><{t}>预览<{/t}></span>
						   </div>
	                  </div>
	            </td>
				</tr>
                </table>
            </div>
        </div>
        <{/foreach}> </div></div>
</form>
<script>

function deleteRow(act,event){
e=$(new Event(event).stop().target);
     var row=e.getParent('.row');

    if(confirm('<{t}>您确定要删除该频道？<{/t}>')){
        W.page(act,{
        method:'get',
        update:'messagebox',
        onComplete:function(re){

            if(re.contains('successSplash')){row.remove();}

            }
        });
    }
}
<{if $tree_number<=1000}>
void function(){
   $E('#hideCat-handle').addEvent('click',function(){
    $ES('#cat_tree .clear_cat').each(function(e){
        if(e.get('depath')>1){
            e.setStyles({'display':'none'});
        }
    });
     $ES('#cat_tree .handle-hide').hide();
     $ES('#cat_tree .handle-show').show();
  });
    $E('#showCat-handle').addEvent('click',function(){

        $ES('#cat_tree .clear_cat').each(function(e){
            if(e.get('depath')>1){
                e.setStyles({'display':''});
            }
        });
     $ES('#cat_tree .handle-hide').show();
    });

    $('cat_tree').addEvent('click',function(e){

       if(!e.target.className.match(/handle-/i))return;


      var handle=$(e.stop().target);
            var eventRow=handle.getParent('.row');
            var visible=handle.hasClass('handle-show')?'':'none';
                if(visible=='none'){
                         handle.hide().getNext().show();
                    }else{
                         handle.hide().getPrevious().show();

                    }
            flode(eventRow,visible);

    });




	$('edit-catsort').addEvent('click',function(){
	     var _ctext = this.get('text').trim();
	  	 if(_ctext=='<{t}>编辑排序<{/t}>'){

		  $$('#cat_tree input[vtype=unsigned]').each(function(item){

			      item.style.cssText = "";
				  item.getNext().setStyle('display','none');

			});
			this.getElement('span span').set({'text':'<{t}>保存排序<{/t}>','styles':{color:'#ff3300'}})
		 }else{
		   $('catEditor').fireEvent('submit',{stop:function(){}});
		}




	});


     function flode(eventRow,visible){
            var cid=eventRow.get('cid');
            var pid=eventRow.get('pid');
            var depath=eventRow.get('depath');

            eventRow.getAllNext('div[pid='+cid+']').each(function(row){
                if(visible=='none'){
                    row.hide();
                    var obj=row.getElements('.handle-icon img');
                    if(obj.length>1){
                        flode(row,visible);
                    }
                }else{
                    row.show();
                    var obj=row.getElements('.handle-icon img');
                    if(obj.length>1){
                        var vis=(obj[0].getStyle('display')=='none'?'none':'inline');
                        flode(row,vis);
                    }
                }

            });
    }
}();
<{/if}>

</script>
