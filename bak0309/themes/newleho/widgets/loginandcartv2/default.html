 <div class="member_login fl">
      <span id="login_<{$widgets_id}>" class="login" >
	  <a href="<{link app=b2c ctl=site_passport act=login}>"><{t app='b2c'}>登录<{/t}></a> 
	</span>
	<span id="member_<{$widgets_id}>"  style="display:none;" class="member_info">
	  <span id="uname_<{$widgets_id}>" class="name"></span>！
	  <a href="<{link app=b2c ctl=site_member act=index}>"><{t app='b2c'}>会员中心<{/t}></a>
	  &nbsp;
	   <a href="<{link app=b2c ctl=site_passport act=logout}>"><{t app='b2c'}>登出<{/t}></a>
	</span>
	<span class="line">|</span>
</div>

<div class="  has-minicart fl"  id="minicart" >
		<a href="<{link app=b2c ctl=site_cart act=index}>"   class="cart minicart-text " >
		<span class="count">0</span>
        </a>
	<div class="minicart-cont">
  	</div>
</div>
                
<script>
var name = Cookie.read('UNAME') || '';
if(name){
	var uname = name.substring(0,6)+'...';
    $("uname_<{$widgets_id}>").innerHTML = uname;
    $("member_<{$widgets_id}>").setStyle('display','');
    $("login_<{$widgets_id}>").setStyle('display','none');
}
else{
    $("login_<{$widgets_id}>").setStyle('display','');
    $("member_<{$widgets_id}>").setStyle('display','none');
}

window.addEvent('domready',function(){
    updateCartInfo();
    
    if ( Cookie.read('S[CART_NUMBER]')==null||Cookie.read('S[CART_NUMBER]')==0)  {
        $('minicart').getElement('.count').innerHTML = 0 ;
    }else{
        $('minicart').getElement('.count').innerHTML = Cookie.read('S[CART_NUMBER]');
    }

    var cartViewUrl='<{link app=b2c ctl=site_cart act=view}>';
    var MiniCarWidgets={
        init:function(){
            var minicart=this.cart= $('minicart');
            this.detailbox=minicart.getElement('.minicart-cont');
            this.handle=minicart.getElement('.minicart-text');
            this.attach();
        },
        attach:function(){
            this.handle.addEvents({
                'mouseenter':function(e){
                    if(e&&this.state) return;
                    this.show();

                    this.request({
                        url:cartViewUrl,
                        method:'post',
                        onRequest:function(){
                            this.detailbox.innerHTML='<div class="loading">加载中...</div>';
                        }.bind(this)
                    });
                }.bind(this)
            });
            this.cart.addEvent('_show',function(e){
                this.handle.fireEvent('mouseenter');
            }.bind(this));
        },
        show:function(e){
            this.cart.addClass('minicart-active');
            this.state=true;
            var self = this;
            $(document.body).addEvent('click',function(){
                self.hide();
                this.removeEvent('click',arguments.callee);
            });
            return this;
        },
        hide:function(){
            this.cart.removeClass('minicart-active');
            this.state=false;
        },
        setHeight: function(el) {
            var h = window.getSize().y - this.detailbox.getPosition(document.body).y + window.getScroll().y - this.detailbox.getPatch().y;
            var dh = this.detailbox.getSize().y - this.detailbox.getPatch('padding', 'border').y;
            if(dh >= h){
                this.detailbox.setStyle('height',h);
            }
            else this.detailbox.setStyle('height', 'auto');
            return this;
        },
        removeCart:function(el){
            this.request({
                url:el.href,
                data:el.getParent('.goods-item')
            });
        },
        addEvent:function(){
            var _this=this;
            this.detailbox.getElements('.action-delete').addEvent('click',function(e){
                e.stop();
                _this.removeCart(this);
            });
        },
        request:function(options){
            options = options || {};
            options.data = (options.data?options.data.toQueryString():'')+'&mini_cart_list=true';
            options = Object.merge({
                method:'post',
                update: this.detailbox,
                onSuccess:function(re){
                    try{
                        updateCartInfo();
                        fixImageSize($$('img[data-img-zoom]'));
                    }catch(e){}
                    this.setHeight().addEvent();
                }.bind(this)
            },options);
            return new Request.HTML(options).send();
        }
    };
    MiniCarWidgets.init();
});
</script>
