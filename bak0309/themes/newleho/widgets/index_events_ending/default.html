<div class="title">即将结束的活动</div>
<{if $data.data}>
<ul>
	<{foreach from=$data.data item=item name=endinglist}>
	<li <{if $smarty.foreach.endinglist.iteration % 3 == 0 }> class="last" <{/if}> >
		<div  class="event_img" >
			<a href="<{link app=shangou ctl=site_event arg0=$item.evt_id}>" ><image src="<{$item.evt_logo|storager}>" title="<{$item.evt_name}>" alt="<{$item.evt_name}>"></a>
		</div>
		<div class="timer">
			<a href="<{link app=shangou ctl=site_event arg0=$item.evt_id}>" title="<{$item.evt_name}>" alt="<{$item.evt_name}>"><{$item.evt_name}></a>
		<!-- 限时倒计时时间 -->
		<span class="date events-time-wrap">
		    <input type="hidden" class="timeStart" value="<{$item.s_time}>" />
            <input type="hidden" class="timeEnd" value="<{$item.e_time}>" />
		距离活动结束还有<span ><t class="day">-</t>天</span><span ><t  class="hour">-</t>小时</span><span ><t  class="minute">-</t>分</span>
		
		</span>
		</div>
	</li>
	 <{/foreach}>
</ul>
 <script>
    (function(){
     var timeBox = $$('.events-time-wrap');
     var timeNow;
     new Request({
         url:'<{$data.url}>',
         onComplete:function(re){
             timeNow=new Date(re*1000);
             if(timeBox.length>0){
               timeBox.each(function(item){
                   var _exitFlag = true;
                   try{
                   var timeStart = new Date((item.getElement('.timeStart').get('value'))*1000);
                   var timeEnd = new Date((item.getElement('.timeEnd').get('value'))*1000);
                   var dom ={
                       day: item.getElement('.day'),
                      // second: item.getElement('.second'),
                       minute:item.getElement('.minute'),
                       hour:item.getElement('.hour')
                       };
                   }catch(e){
                       _exitFlag = false;
                   }
                   if(_exitFlag){
                       if(timeStart.getTime() && timeEnd.getTime()){
                             if(timeStart.getTime() >= timeNow.getTime()){
                                  try{timeCount.init(timeStart,timeNow,dom)}catch(e){};
                            }else if(timeEnd.getTime() > timeNow.getTime()){
                                try{timeCount.init(timeEnd,timeNow,dom)}catch(e){};
                            }
                       }
                   }
               });
             }
         }
     }).send();
    })();

var timeCount = {
    init:function(timeStart,timeEnd,dom,isReload){
        this.isReload = isReload || true;
        var diff = Math.abs((timeStart.getTime() - timeEnd.getTime())/1000);
        var secondDiff = diff % 60;
        var minuteDiff = ((diff - secondDiff)/60) % 60;
        var hourDiff = (diff - secondDiff  - minuteDiff*60) / 3600;
        if(hourDiff > 24){
            var dayDiff = parseInt(hourDiff/24);
            hourDiff = hourDiff - dayDiff * 24;
            var timeDiff = [hourDiff,minuteDiff,secondDiff,dayDiff];
        }else{
            var timeDiff = [hourDiff,minuteDiff,secondDiff];
        }
        this.s = this.calcTime.periodical(1000,this,{
            time:timeDiff,
            dom:dom
        });
    },
    addZero:function(timeDiff){
        for(var i=0;i<timeDiff.length;i++){
            if(timeDiff[i].toString().length<2){
                timeDiff[i] = "0" + timeDiff[i].toString();
                return timeDiff;
            }
        }
    },
    formatToInt : function(timeDiff){
        for(var i=0;i<timeDiff.length;i++){
            parseInt(timeDiff[i]);
        }
        return timeDiff;
    },
    judgeTime : function(timeDiff){
        if(timeDiff[2]< 0  && timeDiff[1]>0){
            timeDiff[2] = 59;
            timeDiff[1]--;
            return timeDiff;
            }else if(timeDiff[2] <0 && timeDiff[1]==0 && timeDiff[0]>0){
            timeDiff[2] = 59;
            timeDiff[1] = 59;
            timeDiff[0]--;
            return timeDiff;
            }else if(timeDiff[2]==0 && timeDiff[1]==0 && timeDiff[0]==0){
            $clear(this.s);
            if(this.isReload) location.reload();
            return;
        }
    },
    calcTime : function (obj){
        if(!obj.dom) return;
        var _timeDiff = obj.time;
       // this.addZero(_timeDiff);
        this.formatToInt(_timeDiff);
        _timeDiff[2]--;
        this.judgeTime(_timeDiff);
        //this.addZero(_timeDiff);
        var dom = obj.dom;
        if(_timeDiff[3]){
            if(dom.day) dom.day.innerHTML = _timeDiff[3];
            if(dom.minute){
                var domBox = dom.minute.getParent('span');
                if(domBox) domBox.hide();
            }
            if(dom.hour) dom.hour.innerHTML = _timeDiff[0];
        }else{
            if(dom.day) {
                var domBox = dom.day.getParent('span');
                if(domBox) domBox.hide();
            }
            if(dom.minute) dom.minute.innerHTML = _timeDiff[1];
            if(dom.hour) dom.hour.innerHTML = _timeDiff[0];
        }
    }
};
</script>
    
<{else}>
<div>暂无即将结束的活动</div>
<{/if}>